<tool id="gmx_rmsd" name="GROMACS RMSD calculation" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">
    <description>of molecular structures</description>
    <macros>
        <import>macros.xml</import>
        <token name="@GALAXY_VERSION@">0</token>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[

    ln -s '$traj_input' ./traj_input.${traj_input.ext} &&
    ln -s '$structure_input' ./structure_input.${structure_input.ext} &&
    #if '$traj2.traj2select' == 'Yes':
    ln -s '$traj2.traj_input2' ./traj_input2.${traj_input2.ext} &&
    #end if
    #if '$ndx_input':
    ln -s '$ndx_input' ./ndx_input.${ndx_input.ext} &&
    #end if
    #if '$fit.fit_type' == 'none':
    echo '$index_rmsdgroup' | gmx rms
    #else
    echo '$fit.index_refgroup' '$index_rmsdgroup' | gmx rms
    #end if
    ##inputs
    -f ./traj_input.${traj_input.ext}  -s ./structure_input.${structure_input.ext}
    #if '$traj2.traj2select' == 'Yes':
    -f2 ./traj_input2.${traj_input2.ext}
    #end if
    #if '$ndx_input':
    -n ./ndx_input.${ndx_input.ext}
    #end if

    -fit '$fit.fit_type'
    -xvg '$outputformat'
    ## other options
    #if $mir == 'true':
    -mir
    #end if

    >> verbose.txt 2>&1
 
    ]]></command>
    <inputs>
        <param name="traj_input" type="data" format="trr,xtc" label="Trajectory file" help="In XTC or TRR format"/>
        <conditional name="traj2">
            <param name="traj2select" type="select" label="Add an additional trajectory file?" help="Can be useful when compraring two different simulations of the same system.">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </param>
            <when value="Yes">
                <param name="traj_input2" type="data" format="trr,xtc" label="Additional trajectory file" help="In XTC or TRR format."/>
            </when>
            <when value="No">
            </when>
        </conditional>
        <param name="structure_input" type="data" format="tpr,pdb,gro" label="Structure file" help="In TPR, PDB, or GRO format. Use a tpr file if your system contains nonstandard atom types, as atomic masses may not be directly obtained from PDB or GRO files."/>
        <param name="ndx_input" type="data" format="ndx" label="Index (NDX) file" help="Index file containing your system's different atomic and molecular groups."/>
        <param name="index_rmsdgroup" value="0" min="0" type="integer" label="Index - RMSD group" help="Index of RMSD group - for proteins, this can generally be the same as the least squares fitting group, but can be different depending on the application."/>
        <conditional name="fit">
            <param name="fit_type" type="select" label="Fit Type" help="controls the least-squares fitting of the structures on top of each other: complete fit (rotation and translation), translation only, or no fitting at all.">
                <option value="rot+trans">Rotation and translation. This is the default way.</option>
                <option value="translation">Translation only.</option>
                <option value="none">No fitting.</option>
            </param>
            <when value="rot+trans">
                <param name="index_refgroup" value="0" min="0" type="integer" label="Index - least squares fitting group" help="Index number of the group you are fitting against, i.e. the reference group. For proteins, this group is commonly Backbone or C-alpha."/>
            </when>
            <when value="translation">
                <param name="index_refgroup" value="0" min="0" type="integer" label="Index - least squares fitting group" help="Index number of the group you are fitting against, i.e. the reference group. For proteins, this group can be Backbone or C-alpha."/>
            </when>
            <when value="none">
            </when>
        </conditional>
        <param name="outputformat" type="select" label="Output format">
            <option value="xmgrace">Xmgrace. This is the default way.</option>
            <option value="none">Raw Data.</option>
        </param>
        <param name="mir" type="select" label="Compare results with mirror image of the reference structure?" help="This is useful as a reference for assesing ‘significant’ RMSD values.">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </param>
        <expand macro="log"/>
    </inputs>
    <outputs>
        <data name="output1" format="xvg" from_work_dir="rmsd.xvg" label="GROMACS calculation of RMSD on ${on_string}"/>
        <data name="output2" format="xvg" from_work_dir="rmsdmir.xvg" label="GROMACS calculation of mirror image RMSD on ${on_string}">    
            <filter>mir == 'true'</filter>
        </data>
        <expand macro="log_outputs"/>
    </outputs>
    <tests>
        <test>
            <param name="traj_input" value="npt.xtc"/>
            <param name="structure_input" value="npt.tpr" ftype="tpr"/>
            <param name="ndx_input" value="index.ndx" ftype="ndx"/>
            <param name="index" value="3"/>
            <param name="outputformat" value="xmgrace"/>
            <output name="output1" ftype="xvg">
                <assert_contents>
                    <has_text text="0.1000000    0.0391476"/>
                    <has_text text="0.2000000    0.0598719"/>
                    <has_text text="0.3000000    0.0842008"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="traj_input" value="npt.xtc"/>
            <param name="structure_input" value="npt.tpr" ftype="tpr"/>
            <param name="ndx_input" value="index.ndx" ftype="ndx"/>
            <param name="index" value="1"/>
            <param name="resavg" value="true"/>
            <param name="outputformat" value="none"/>
            <output name="output1" ftype="xvg">
                <assert_contents>
                    <has_text text="0.1000000    0.0391476"/>
                    <has_text text="0.2000000    0.0598719"/>
                    <has_text text="0.3000000    0.0842008"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

        .. class:: infomark
        
        **What it does**
        
        This tool calculates a structure's Root Mean Square Deviation (RMSD), using the built-in gromacs function gmx rms.
        
_____
        
        .. class:: infomark
        
        **Input**
        
               - GRO, PDB, or TPR structure file.
               - TRR or XTC trajectory file.
        
        
_____
        
        
        .. class:: infomark
        
        **Output**
        
               - XVG file containing RMSD results.
        
            ]]></help>
    <expand macro="citations"/>
</tool>
